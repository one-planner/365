<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- jQuery -->
  <script src="/webjars/jquery/3.7.1/jquery.min.js"></script>
  <!-- jQuery UI -->
  <script src="/webjars/jquery-ui/1.13.1/jquery-ui.js"></script> <!-- 일정 추가의 날짜를 선택할 때 달력 표시 기능 -->
  <link rel="stylesheet" href="/webjars/jquery-ui/1.13.1/jquery-ui.css"> <!-- 일정 추가의 날짜 선택할 때 달력을 꾸며줌-->

  <!--flatpickr (미니 달력)-->
  <link rel="stylesheet" href="/webjars/flatpickr/4.6.13/dist/flatpickr.min.css">
  <script src="/webjars/flatpickr/4.6.13/dist/flatpickr.min.js"></script>
  <script src="/webjars/flatpickr/4.6.13/dist/l10n/ja.js"></script> <!-- 일본어 설정-->

  <!-- full calendar (메인 달력) -->
  <script src='/webjars/fullcalendar/6.1.9/index.global.min.js'></script>

  <!-- Datetimepicker -->
  <link rel="stylesheet" href="/webjars/datetimepicker/2.5.20-1/jquery.datetimepicker.css">
  <script src="/webjars/datetimepicker/2.5.20-1/jquery.datetimepicker.js"></script>

  <!-- Custom CSS -->
  <link href="/css/calendarMini.css" rel="stylesheet">

  <style>
    /* 스타일 추가 */
    body {
      font-family: Arial, sans-serif;
      width: 1900px;
    }

    .calendar {
      display: flex;
      width: 100%;
      padding-top: 40px;
      justify-content: space-evenly;
    }

    #main-calendar {
      width: 70%;
    }

  </style>
</head>

<body>

<div class='calendar'>
  <!-- 미니 달력 컨테이너 -->
  <div id="mini-calendar"></div>

  <!-- 메인 달력 컨테이너 -->
  <div id="main-calendar"></div>

  <div id="eventForm">
    <h3>일정 추가</h3>
    <form id="addEventForm">
      <!-- 이벤트 제목 입력 -->
      <label for="title">제목</label>
      <input type="text" id="title" name="title" required>
      <br>
      <!-- 이벤트 하루종일 선택 여부 -->
      <label for="allDay">하루종일</label>
      <input type="checkbox" id="allDay" name="allDay" checked>
      <br>
      <!-- 시작 이벤트 날짜 선택 -->
      <label for="startDate">시작일</label>
      <input type="text" id="startDate" name="startDate" readonly>
      <br>
      <!-- 시작 이벤트 시간 선택 -->
      <label for="startTime">시작시간</label>
      <input type="text" id="startTime" name="startTime" readonly>
      <br>
      <!-- 종료 이벤트 날짜 선택 -->
      <label for="endDate">종료일</label>
      <input type="text" id="endDate" name="endDate" readonly>
      <br>
      <!-- 종료 이벤트 시간 선택 -->
      <label for="endTime">종료시간</label>
      <input type="text" id="endTime" name="endTime" readonly>
      <br>
      <!-- 이벤트 반복 선택 -->
      <label for="repeat">반복</label>
      <select name="repeat">
        <option value="1">매일</option>
        <option value="2">해당 요일마다</option>
        <option value="3">평일</option>
        <option value="4">주말 및 공휴일</option>
      </select>
      <br>
      <!-- 이벤트 내용 선택 -->
      <label for="content">내용</label>
      <textarea id="content" name="content"></textarea>
      <br>
      <!-- 이벤트 장소 선택 -->
      <label for="place">장소</label>
      <input id="place" name="place">
      <br>
      <!-- 일정 알람 선택 여부 -->
      <label for="alarm">알람</label>
      <input type="checkbox" id="alarm" name="alarm" checked>
      <br>
      <!--<input type="hidden" id="userEmail" name="userEmail">-->
      <!-- 이벤트 추가 버튼 -->
      <button onclick="insertPlan();">추가</button>
    </form>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 미니 달력 설정
    var miniCalendar = flatpickr("#mini-calendar", {
      inline: true,
      shorthandCurrentMonth: true,
      static: true,
      locale: "ja", // 일본어로 설정
      onChange: function (selectedDates, dateStr, instance) {
        // 메인 달력 갱신
        updateMainCalendar(selectedDates[0]);
      }
    });

    // 메인 달력 설정
    var calendarEl = document.getElementById('main-calendar');
    var mainCalendar = new FullCalendar.Calendar(calendarEl, {
      headerToolbar: {
        left: 'prevYear,prev,next,nextYear today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      buttonText: {
        today: '今日',
        month: '月',
        week: '週',
        day: '日',
        list: '目錄'
      },
      height: '700px', // calendar 높이 설정
      initialView: 'dayGridMonth', // 캘린더를 초기에 월별 뷰로 설정
      initialDate: new Date(), // 달력 처음 로드될때 표시되는 날짜를 현재 날짜로 설정
      navLinks: true, // 요일 및 날짜 클릭 시 일이나 주 단위 보여주는 화면으로 넘어가기
      selectable: true, // 날짜를 선택 및 드래그해서 새 이벤트를 추가 => 날짜 클릭시 파랑색으로 표시해줌
      editable: true, // 드래그해서 수정 여부
      droppable: true, // 타 이벤트 및 요소를 끌어 놓을 수 있게 설정
      dayMaxEvents: true, // +more 표시 전 최대 이벤트 갯수, true는 셀 높이에 의해 결정
      dayMaxEventRows: true, // 셀 높이에 따라 이벤트 표시
      fixedWeekCount: false, // 다음 달에 해당되는 날짜 미리 보여짐 여부
      locale: 'ja', // 원하는 지역(언어)로 설정


      dateClick: function (info) {
        // 날짜를 클릭하면 미니 달력 선택 날짜 갱신
        miniCalendar.setDate(info.date); // 이걸 안해주면 메인 캘린더 날짜를 클릭해도 미니 달력에 반영이 안된다
        // 단 미니 달력에서 날짜 클릭하면 메인 달력에 반영이 된다
        console.log(info);
        showForm(info);
      }
    });

    // 메인 달력 렌더링. 이 메서드를 호출해야 캘린더가 표시됨
    mainCalendar.render();

    // 메인 달력 갱신 함수
    function updateMainCalendar(date) {
      mainCalendar.gotoDate(date);
      mainCalendar.changeView('timeGridDay');
    }

    // datepicker 초기화 날짜
    $('#startDate, #endDate').datepicker({
      dateFormat: 'yy-mm-dd',
      onSelect: function (dateText) {
        $('#startDate').val(dateText);
        $('#endDate').val(dateText);
      }
    });

    // datetimepicker 초기화
    /*$('#startTime, #endTime').datetimepicker({
        format: 'H:i',
        step: 15, // 시간 간격 설정 (예: 15분 간격)
        allowTimes: [ // 선택 가능한 시간 목록
        '00:00', '00:15', '00:30', '00:45',
        '01:00', '01:15', '01:30', '01:45',
        // ... 중간 생략 ...
        '22:00', '22:15', '22:30', '22:45',
        '23:00', '23:15', '23:30', '23:45'
      ]
    });

    // datetimepicker를 더블클릭하여 날짜 및 시간 선택
$('#startTime, #endTime').on('dblclick', function () {
  $(this).datetimepicker('show');
});*/

    // 폼 제출 처리
    $('#addEventForm').submit(function (e) {
      e.preventDefault();

      var title = $('#title').val();
      var startDate = $('#startDate').val();
      var endDate = $('#endDate').val();
      var startTime = $('#startTime').val();
      var endTime = $('#endTime').val();

      if (title && startDate && endDate && startTime && endTime) {
        // FullCalendar에 이벤트 추가
        mainCalendar.addEvent({
          title: title,
          start: startDate,
          end: endDate
        });

        // 폼 숨기기
        hideEventForm();
      }
    });

    // 외부 클릭으로 폼 닫기
    $(document).mouseup(function (e) {
      var container = $("#eventForm");
      if (!container.is(e.target) && container.has(e.target).length === 0) {
        hideEventForm();
      }
    });

    function showForm(date) {
      // 클릭한 날짜에 이벤트 폼 표시
      var eventForm = $('#eventForm');

      // 새로운 방법으로 클릭한 날짜의 요소 가져오기 (예시)
      var dayElement = date.dayEl || date.el;

      eventForm.css({
        left: $(window).width() / 2 - eventForm.width() / 2,
        top: dayElement.offsetTop,
        display: 'block'
      });
      $('#startDate').val(date.dateStr);
      $('#endDate').val(date.dateStr);

      // 시간 설정 (예시: 현재 시간 기본값 설정)
      var hours = new Date().getHours();
      var minutes = new Date().getMinutes();

      // 시간을 두 자리로 맞춤
      hours = hours < 10 ? '0' + hours : hours;
      minutes = minutes < 10 ? '0' + minutes : minutes;

      $('#startTime').val(hours + ':' + minutes);
      $('#endTime').val(hours + ':' + minutes);
    }

    function hideEventForm() {
      // 이벤트 폼 숨기기
      $('#eventForm').hide();
      $('#addEventForm')[0].reset();
    }
  });
</script>

<!-- ajax -->
<script>
  function insertPlan() {
    // 폼에서 데이터 가져오기

    var plan = {
      title : $('#title').val(),
      startDate : $('#startDate').val(),
      startTime : $('#startTime').val(),
      endDate : $('#endDate').val(),
      endTime : $('#endTime').val(),
      content : $('#content').val(),
      place : $('#place').val()
    };
    $.ajax({
      type: "post",
      url: "/insert",
      contentType: 'application/json',
      data: JSON.stringify(plan),
      success: function (response) {
        console.log(response);
      },
      error: function (error) {
        console.error('일정 저장 중 오류 발생:', error);
      }
    })
  };
</script>

</body>

</html>